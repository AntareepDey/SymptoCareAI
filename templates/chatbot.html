<!DOCTYPE html>
<html>
<head>
    <title>Chatbot</title>
    <link rel="stylesheet" type="text/css" href="/Static/chat.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
</head>
<body>
    <div class="chatbot">
        <header><h2>Chatbot</h2></header>
        <ul class="chatbox">
            <li class="chat incoming">
                <span class="material-icons-outlined">bot</span>
                <p>Hi thereðŸ‘‹<br> How can i help you today?</p>
            </li>
            <li class="chat outgoing">
                <p>Color, sit amet consectetur adipisicing elit. 
                    Consectetur perferendis laboriosam aLorem ipsum drchitecto 
                </p>
            </li>
        </ul>
        <div class="chat-input">
                <textarea placeholder="Type a message..." required></textarea>
                <button><span id="send-btn" class="material-icons-rounded">send</span></button>   
        </div>    
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const chatbox = $(".chatbox");
            const chatInput = $(".chat-input textarea");
            const sendChatBtn = $(".chat-input span");

            let userMessage = null;
            const inputInitHeight = chatInput[0].scrollHeight;
            //dont tounch this
            const createChatLi = (message, className) => {
                const chatLi = $("<li>").addClass("chat").addClass(className);
                let chatContent = className === "outgoing"
                    ? $('<p>').text(message)
                    : $('<span>').addClass("material-symbols-outlined").text("smart_toy").add($('<p>').text(message));
                chatLi.html(chatContent);
                return chatLi;
            }
            //needs to be changed, no proper response form the server
            const generateResponse = (chatElement,userMessage) => {
                const API_URL = "/chatbot"; // Flask API endpoint
                const messageElement = chatElement.find("p");
                const conversation = [userMessage]; // User's message];
                console.log(conversation);
                $.ajax({
                    type: "POST",
                    url: API_URL,
                    contentType: "application/json",
                    data: JSON.stringify({ "message": userMessage }), // send the user message as a JSON object with a key of "message"
                    success: function (data) {
                        messageElement.text(data.response);
                    },
                    error: function () {
                        messageElement.addClass("error").text("Oops! Something went wrong. Please try again.");
                    },
                    complete: function () {
                        chatbox.scrollTop(chatbox[0].scrollHeight);
                    }
                });
            }

            const handleChat = () => {
                userMessage = chatInput.val().trim();
                if (!userMessage) return;

                chatInput.val("");
                chatInput.css("height", `${inputInitHeight}px`);

                chatbox.append(createChatLi(userMessage, "outgoing"));
                chatbox.scrollTop(chatbox[0].scrollHeight);

                setTimeout(() => {
                    const incomingChatLi = createChatLi("Thinking...", "incoming");
                    chatbox.append(incomingChatLi);
                    chatbox.scrollTop(chatbox[0].scrollHeight);
                    generateResponse(incomingChatLi,userMessage);
                }, 600);
            }

            chatInput.on("input", () => {
                chatInput.css("height", `${inputInitHeight}px`);
                chatInput.css("height", `${chatInput[0].scrollHeight}px`);
            });

            chatInput.on("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
                    e.preventDefault();
                    handleChat();
                }
            });

            sendChatBtn.on("click", handleChat);
        });
    </script>
</body>
</html>
